---
title: "KGD_Cardio"
format: html
editor: visual
---

```{r}
# Подключаем setup.R из папки lib
source("lib/setup.R")

# Нужен для чтения форматирования (цвет шрифта) из xlsx/xlsm
library(tidyxl)

# Список файлов
file_paths <- c(
  "ОКС. База 2025.xlsm",
  "ОКС. База 2024.xlsx",
  "ОКС. База 2023.xlsx",
  "ОКС. База 2022.xlsx",
  "ОКС. База 2021.xlsx"
)

# Функция парсинга дат
parse_dates <- function(dates) {
  result <- rep(NA, length(dates))

  for (i in seq_along(dates)) {
    val <- dates[i]
    if (is.na(val) || val == "") next

    formats <- c(
      "%Y-%m-%d %H:%M:%S",
      "%d.%m.%Y %H:%M:%S",
      "%d.%m.%Y %H:%M",
      "%Y-%m-%d",
      "%d.%m.%Y"
    )

    parsed <- NA
    for (fmt in formats) {
      try_date <- try(as.POSIXct(val, format = fmt), silent = TRUE)
      if (!inherits(try_date, "try-error") && !is.na(try_date)) {
        parsed <- try_date
        break
      }
    }

    if (is.na(parsed)) {
      num_val <- suppressWarnings(as.numeric(val))
      if (!is.na(num_val)) {
        parsed <- as.POSIXct((num_val - 25569) * 86400, origin = "1970-01-01", tz = "UTC")
      }
    }

    result[i] <- parsed
  }

  as.POSIXct(result, origin = "1970-01-01", tz = "UTC")
}

# NEW: детектор "зелёного" по ARGB (FFRRGGBB)
is_green_rgb <- function(rgb) {
  if (is.na(rgb) || !nzchar(rgb)) return(FALSE)
  rgb <- toupper(rgb)
  if (!stringr::str_detect(rgb, "^[0-9A-F]{8}$")) return(FALSE)

  r <- strtoi(substr(rgb, 3, 4), 16L)
  g <- strtoi(substr(rgb, 5, 6), 16L)
  b <- strtoi(substr(rgb, 7, 8), 16L)

  # "зелёный доминирует" (подходит для типичных FF00B050, FF008000 и т.п.)
  (g >= 80) && (g - r >= 30) && (g - b >= 30)
}

# Функция обработки файла
process_file <- function(file_path) {
  if (!file.exists(file_path)) return(NULL)

  year <- str_extract(file_path, "\\d{4}")

  # Читаем сырые данные, сохраняем индексы непустых строк ДО фильтрации
  raw_data <- read_excel(file_path, sheet = "ОКС все", col_types = "text")
  non_blank <- apply(raw_data, 1, function(row) any(!is.na(row) & row != ""))
  data <- raw_data[non_blank, ]
  if (nrow(data) == 0) return(NULL)

  find_col <- function(names, patterns) {
    for (pattern in patterns) if (pattern %in% names) return(pattern)
    NULL
  }

  result <- tibble(
    year = year,
    exl_sheet = 1,
    exl_row = seq_len(nrow(data)) + 1
  )

  add_col <- function(result, data, col_name, patterns) {
    found <- find_col(names(data), patterns)
    result[[col_name]] <- if (!is.null(found)) data[[found]] else NA_character_
    result
  }

  result <- add_col(result, data, "age", c("возраст, годы", "возр.", "возраст"))
  result <- add_col(result, data, "high", c("рост, м", "рост"))
  result <- add_col(result, data, "sex", c("пол (ж или м)", "пол м/ж", "пол"))
  result <- add_col(result, data, "recordID", c("№ИБ (без указания года)", "№ИБ", "ИБ"))
  result <- add_col(result, data, "admissionDateTime", c("дата и время госпитализации", "дата госпитализации"))
  result <- add_col(result, data, "ICU_EndDateTime", c("дата перевода из ОАР№2", "перевод из ОАР", "Время перевода"))
  result <- add_col(result, data, "ICU_dur_exl", c("пребывание в орит, часы", "пребывание в ОРИТ"))
  result <- add_col(result, data, "adrenaline", c("адреналин (0-нет, да - доза, мкг/кг/мин)", "адреналин"))
  result <- add_col(result, data, "noradrenaline", c("НА (0-нет, 1 - доза, мкг/кг/мин)", "НА"))
  result <- add_col(result, data, "dopamine", c("допмин (0-нет, да - доза, мкг/кг/мин)", "допмин"))
  result <- add_col(result, data, "dobutamine", c("добутамин (0-нет, 1 - доза, мкг/кг/мин)", "добутамин"))
  result <- add_col(result, data, "RRT", c("ЗПТ (0-нет, 1 - да, 2-несколько сеансов)", "ЗПТ"))
  result <- add_col(result, data, "MV", c("длительность ИВЛ, часы", "ИВЛ"))
  result <- add_col(result, data, "sepsis", c("сепсис (0-нет, 1 - да)", "сепсис"))
  result <- add_col(result, data, "SOFA", c("SOFA макс", "SOFA"))

  find_starts_with <- function(data, pattern) {
    matches <- names(data)[str_detect(names(data), paste0("^", pattern))]
    if (length(matches) > 0) return(data[[matches[1]]])
    rep(NA_character_, nrow(data))
  }

  result$revasc_history <- find_starts_with(data, "реваскуляризация")
  result$surgery <- find_starts_with(data, "ОПЕРАЦИЯ")
  result$re_admission <- find_starts_with(data, "повторное поступление")
  result$CBP <- find_starts_with(data, "ИК")

  outcome_names <- c("исход  (завершение стац этапа)", "исход", "Исход")
  result$outcome <- NA_character_
  for (name in outcome_names) {
    if (name %in% names(data)) {
      result$outcome <- data[[name]]
      break
    }
  }
  if (all(is.na(result$outcome))) {
    result$outcome <- find_starts_with(data, "исход")
  }

  death_names <- c("Лет-й исход", "летальный исход", "смерть")
  result$death <- NA_character_
  for (name in death_names) {
    if (name %in% names(data)) {
      result$death <- data[[name]]
      break
    }
  }

  # NEW: death_green по цвету шрифта в колонке "ФИО"
  death_green <- rep(0L, nrow(data))

  # строки в Excel (в терминах tidyxl): header = row 1, данные начинаются с row 2
  kept_rows_excel <- which(non_blank) + 1L

  try({
    cells <- tidyxl::xlsx_cells(file_path, sheets = "ОКС все", include_blank_cells = FALSE)
    formats <- tidyxl::xlsx_formats(file_path)

    rgb_vec <- formats$local$font$color$rgb
    green_font_ids <- which(vapply(rgb_vec, is_green_rgb, logical(1)))

    # индекс колонки "ФИО" (сначала по заголовкам readxl, если не нашли — по header-строке tidyxl)
    fio_col_idx <- which(stringr::str_trim(names(raw_data)) == "ФИО")[1]
    if (is.na(fio_col_idx)) {
      fio_header <- dplyr::filter(
        cells, row == 1, data_type == "character", stringr::str_trim(character) == "ФИО"
      )
      fio_col_idx <- fio_header$col[1]
    }

    if (!is.na(fio_col_idx) && length(green_font_ids) > 0) {
      fio_cells <- dplyr::filter(cells, col == fio_col_idx, row %in% kept_rows_excel)
      green_rows_excel <- fio_cells$row[fio_cells$local_format_id %in% green_font_ids]
      death_green <- as.integer(kept_rows_excel %in% green_rows_excel)
    }
  }, silent = TRUE)

  result$death_green <- death_green

  result
}

# Обработка всех файлов
all_data <- map(file_paths, process_file) %>%
  compact() %>%
  bind_rows()

# Создание финального датасета
final_dataset <- all_data %>%
  mutate(
    age = as.numeric(str_replace(age, ",", ".")),

    across(c(high, ICU_dur_exl, adrenaline, noradrenaline,
             dopamine, dobutamine, MV, SOFA),
           ~ as.numeric(str_replace(.x, ",", "."))),

    across(c(sex, recordID, revasc_history, surgery, re_admission,
             RRT, CBP, sepsis, death, outcome), as.character),

    high = ifelse(high > 100, high / 100, high),
    
    # гарантируем 0/1 числом
    death_green = as.integer(death_green),

    year = as.character(year),
    exl_sheet = as.character(exl_sheet),
    exl_row = as.character(exl_row),
    admissionDateTime = parse_dates(admissionDateTime),
    ICU_EndDateTime = parse_dates(ICU_EndDateTime),
    patientID = paste(year, exl_sheet, exl_row, sep = "-"),
    ICU_dur_calc = ifelse(
      !is.na(admissionDateTime) & !is.na(ICU_EndDateTime) & ICU_EndDateTime > admissionDateTime,
      floor(as.numeric(difftime(ICU_EndDateTime, admissionDateTime, units = "hours"))),
      ICU_dur_exl
    ),
    vasopressors = case_when(
      !is.na(adrenaline) & !is.na(noradrenaline) ~ adrenaline + noradrenaline,
      !is.na(adrenaline) ~ adrenaline,
      !is.na(noradrenaline) ~ noradrenaline,
      TRUE ~ NA_real_
    ),
    inotropes = case_when(
      !is.na(dopamine) & !is.na(dobutamine) ~ dopamine + dobutamine,
      !is.na(dopamine) ~ dopamine,
      !is.na(dobutamine) ~ dobutamine,
      TRUE ~ NA_real_
    )
  ) %>%
  select(
    patientID, # год - лист Excel - номер строки Excel
    age, 
    high, # рост, м
    sex, 
    recordID, # №ИБ (без указания года)
    admissionDateTime, # дата и время госпитализации
    ICU_EndDateTime, # дата перевода из ОАР№2
    ICU_dur_calc, # разность между "дата и время госпитализации" и "дата перевода из ОАР№2"
    revasc_history, # реваскуляризация в анамнезе (0-нет, 1-АКШ, 2-ЧКВ, если АКШ+ЧКВ - 3, 4-неизвестно)
    surgery, # ОПЕРАЦИЯ, название (включая БАП)
    re_admission, # повторное поступление (0-нет, 1 - да)
    vasopressors, # сумма адреналин и НА (0-нет, да - доза, мкг/кг/мин)
    inotropes, # сумма допмин и добутамин (0-нет, да - доза, мкг/кг/мин)
    RRT, # ЗПТ (0-нет, 1 - да, 2-несколько сеансов)
    MV, # длительность ИВЛ, часы
    CBP, # ИК как метод лечения ОСН (0-нет, 1-да)
    sepsis, 
    SOFA, #SOFA макс
    death, # летальный исход/смерть
    outcome, # исход
    death_green # 1 - строка выделена зеленым, 0 - не выделена
  )

# Сохранение
saveRDS(final_dataset, "final_oks_dataset.rds")

```

You can add options to executable code like this

```{r}
#| echo: false
2 * 2
```

The `echo: false` option disables the printing of code (only output is displayed).
